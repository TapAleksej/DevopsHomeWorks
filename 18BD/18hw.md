научиться реализовывать отказоустойчивое решение для баз
данных на примере Postgresql)

Задание 1:
1 Создать два сервера, установить на них PostgreSQL и подключить их к
одной сети.

На одной виртуальной машине установил postgresql. 

```bash
sudo apt install curl ca-certificates  
sudo install -d /usr/share/postgresql-common/pgdg  
sudo curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc  
. /etc/os-release  
sudo sh -c "echo 'deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $VERSION_CODENAME-pgdg main' > /etc/apt/sources.list.d/pgdg.list"  
sudo apt update  
sudo apt -y install postgresql
```

Клонировал.  
Получились 2 сервера 
master 192.168.50.34

Меняю ip c клона 192.168.50.34
slave  192.168.50.44
```
ip -o a 

2: enp0s3    inet 192.168.50.34/24 brd 192.168.50.255 scope global noprefixroute enp0s3\       valid_lft forever forever


sudo ifconfig -a
```


меняю на 44
```
network:
  version: 2
  ethernets:
    enp0s3:
      renderer: NetworkManager
      match: {}
      addresses:
      - "192.168.50.44/24"
      nameservers:
        addresses:
        - 8.8.8.8
      dhcp6: true
      networkmanager:
        uuid: "1eef7e45-3b9d-3043-bee3-fc5925c90273"
        name: "netplan-enp0s3"
        passthrough:
          connection.timestamp: "1749721436"
          ipv4.address1: "192.168.50.44/24,192.168.50.1"
          ipv4.method: "manual"
          proxy._: ""
```
Проверка
```
sudo netplan try
```

и машина для Consul 
192.168.50.55 



2 Настроить репликацию между серверами, чтобы изменения, вносимые
на одном сервере, автоматически реплицировались на другой.

На мастер
```
psql

postgres=# show data_directory;
       data_directory
-----------------------------
 /var/lib/postgresql/17/main

create role replicator with replication login password 'replpass';
CREATE ROLE
postgres=# exit

```
**Конфигурация мастер**

```
sudo vim /etc/postgresql/17/main/postgresql.conf
```

```bash
# -----------
# FILE LOCATIONS
# -------------
wal_level = replica
# колво одновременных подключений
max_wal_senders = 10
# минимальный размер wal файлов, который не будет удалятся
wal_keep_size = 1GB
hot_stanby = on
```
Разремим и поменяем localhost на '0.0.0.0'
```
listen_addresses '0.0.0.0'
```

```

```bash
sudo vim /etc/postgresql/17/main/pg_hba.conf


host    replication     replicator      192.168.50.44/32        md5

```


```bash
sudo systemctl restart postgresql
ps aufx  | grep postgres


Что то не так ...

sudo less /var/log/postgresql/postgresql-17-main.log
unrecognized configuration parameter "hot_stanby" in file "/etc/postgresql/17/main/postgresql.conf" line 43

Поправил hot_standby
запустился


```
Создадим реплику

```
sudo su - postgres
psql
psql (17.5 (Ubuntu 17.5-1.pgdg24.04+1))
Type "help" for help.

postgres=# select pg_create_physical_replication_slot('replica_slot');
 pg_create_physical_replication_slot
-------------------------------------
 (replica_slot,)
(1 row)

postgres=# exit

```

**Slave настройка**

 Конфигурация
```bash
sudo vim /etc/postgresql/17/main/postgresql.conf
```
Меняем и раскоментим
```bash
listen_addresses '0.0.0.0'
```
Вставить  
```bash
# -----------
# FILE LOCATIONS
# -------------

hot_standby = on
```

Перед удалением данных делаем архив
```
mkdir  /home/alrex/Homework/DevopsHomeWorks/arh
sudo  cp -R /var/lib/postgresql/17/main/ /home/alrex/Homework/DevopsHomeWorks/
 ls /home/alrex/Homework/DevopsHomeWorks/main/
base          pg_dynshmem   pg_notify    pg_snapshots  pg_subtrans  PG_VERSION  postgresql
```
Теперь удаляем
```
sudo -i
systemctl stop postgresql
cd /var/lib/postgresql/17/main
rm -rf *
ls
exit

```

Укажем где мастер

Password = 'replpass'
```
sudo -u postgres pg_basebackup \
-h 192.168.50.34 -p5432 -U replicator \
-D /var/lib/postgresql/17/main \
-Fp -Xs -P -R \
--slot=replica_slot

Password:
23199/23199 kB (100%), 1/1 tablespace

```
Проверка работы postgre - ok
```
sudo systemctl start postgresql
ps aufx  | grep postgres
 
```

Проверим репликацию
На мастере
```sql
create database app;
CREATE DATABASE
postgres=# \c app;
You are now connected to database "app" as user "postgres".
app=# create table logs (id SERIAL PRIMARY KEY,
                                        endpoint varchar(255),
                                        method varchar(255),
                                        satus_code integer
                                        );
CREATE TABLE
               
app=# insert into logs (endpoint, method, satus_code)
values ('/login', 'GET', 405), ('/exit', 'POST', 200);
INSERT 0 2
```

На slave - ура всё есть - репликация работает!!!
```sql
sudo su - postgres
postgres@ubuntu1:~$ psql
psql (17.5 (Ubuntu 17.5-1.pgdg24.04+1))
Type "help" for help.

postgres=# \c app;
You are now connected to database "app" as user "postgres".
app=# select * from logs;
 id | endpoint | method | satus_code
----+----------+--------+------------
  1 | /login   | GET    |        405
  2 | /exit    | POST   |        200
(2 rows)

```


3 Настроить отказоустойчивость, используя репликацию и механизм
автоматического переключения между серверами.



4 Проверить работу отказоустойчивого решения, симулируя отказ одного
из серверов и убедившись, что второй сервер продолжает работу и все
данные сохранены.

Опционально:
● Настроить систему резервного копирования, чтобы регулярно создавать
бэкапы данных и сохранять их на отдельном сервере.

● Документировать все шаги по настройке и проверке отказоустойчивого
решения и подготовить отчет о выполненной работе.
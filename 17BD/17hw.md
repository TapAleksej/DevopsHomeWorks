
```sql
CREATE DATABASE medcenter;
use medcenter;

CREATE TABLE Groups (
    gr_id INT PRIMARY KEY,
    gr_name VARCHAR(255) NOT NULL,
    gr_temp VARCHAR(50) NOT NULL
);

CREATE TABLE Analysis (
    an_id INT PRIMARY KEY,
    an_name VARCHAR(255) NOT NULL,
    an_cost DECIMAL(10, 2) NOT NULL,
    an_price DECIMAL(10, 2) NOT NULL,
    an_group INT,
    FOREIGN KEY (an_group) REFERENCES Groups(gr_id)
);

CREATE TABLE Orders (
    ord_id INT PRIMARY KEY,
    ord_datetime DATETIME NOT NULL,
    ord_an INT,
    FOREIGN KEY (ord_an) REFERENCES Analysis(an_id)
);

-- Заполнение таблицы Groups
INSERT INTO Groups (gr_id, gr_name, gr_temp)
VALUES
    (1, 'Группа 1', '+4°C'),
    (2, 'Группа 2', '-20°C'),
    (3, 'Группа 3', '+20°C');

-- Заполнение таблицы Analysis
INSERT INTO Analysis (an_id, an_name, an_cost, an_price, an_group)
VALUES
    (1, 'Анализ 1', 100.00, 150.00, 1),
    (2, 'Анализ 2', 200.00, 250.00, 2),
    (3, 'Анализ 3', 50.00, 75.00, 3),
    (4, 'Анализ 4', 300.00, 350.00, 1),
    (5, 'Анализ 5', 400.00, 450.00, 2);

INSERT INTO Orders (ord_id, ord_datetime, ord_an)
VALUES
    (1, '2020-02-05 10:00:00', 1),
    (2, '2020-02-06 12:00:00', 2),
    (3, '2020-02-07 14:00:00', 3),
    (4, '2020-02-08 16:00:00', 1),
    (5, '2020-02-09 18:00:00', 4),
    (6, '2020-02-10 20:00:00', 5),
    (7, '2020-02-11 22:00:00', 2),
    (8, '2020-02-12 00:00:00', 3);
```


## Решение 1

```sql
select a.an_name, a.an_price
from Orders o 
	inner join Analysis a on a.an_id = o.ord_an
where o.ord_datetime >='2020-02-05 10:00:00' 
	and o.ord_datetime <= '2020-02-12 00:00:00';

```
MariaDB [medcenter]> select a.an_name, a.an_price
    -> from Orders o
    -> inner join Analysis a on a.an_id = o.ord_an
    -> where o.ord_datetime >='2020-02-05 10:00:00'
    -> and o.ord_datetime <= '2020-02-12 00:00:00';
+----------------+----------+
| an_name        | an_price |
+----------------+----------+
| Анализ 1       |   150.00 |
| Анализ 2       |   250.00 |
| Анализ 3       |    75.00 |
| Анализ 1       |   150.00 |
| Анализ 4       |   350.00 |
| Анализ 5       |   450.00 |
| Анализ 2       |   250.00 |
| Анализ 3       |    75.00 |
+----------------+----------+
8 rows in set (0.001 sec)

## Решение 2
На одном курсе много студентов и наоборот, 
поэтому добавим многие ко многим

```sql

select s.name_sudent , c.name_course
from students s
	left join course_students on cs.sudent_id = s.sudent_id
	inner join course c on c.course_id = cs.course_id
```
## Решение 3
### Создать бекап БД

```bash
sudo mysqldump -u root -p${DB_PASS} medcenter > medcenter_2025-07_28.sql
# на внешнем диске по сети
sudo mkdir /mnt/smb/Obmen/backup
sudo rsync -az medcenter_2025-07_28.sql /mnt/smb/Obmen/backup/

sudo ls /mnt/smb/Obmen/backup
medcenter_2025-07_28.sql

```
### Напортачить в бд и восстановить архив (2-4 шаги)

```sql
sudo mysql -u root -p${DB_PASS}
# :tcbylf22

drop table medcenter.Orders

show tables;
+---------------------+
| Tables_in_medcenter |
+---------------------+
| Analysis            |
| Groups              |
+---------------------+
exit
```

```bash
sudo mysql -u root -p${DB_PASS} medcenter < /mnt/smb/Obmen/backup/medcenter_2025-07_28.sql
```

Проверка
```sql
use medcenter
show tables;
+---------------------+
| Tables_in_medcenter |
+---------------------+
| Analysis            |
| Groups              |
| Orders              |
+---------------------+
MariaDB [medcenter]> select * from Orders;
+--------+---------------------+--------+
| ord_id | ord_datetime        | ord_an |
+--------+---------------------+--------+
|      1 | 2020-02-05 10:00:00 |      1 |
|      2 | 2020-02-06 12:00:00 |      2 |
|      3 | 2020-02-07 14:00:00 |      3 |
|      4 | 2020-02-08 16:00:00 |      1 |
|      5 | 2020-02-09 18:00:00 |      4 |
|      6 | 2020-02-10 20:00:00 |      5 |
|      7 | 2020-02-11 22:00:00 |      2 |
|      8 | 2020-02-12 00:00:00 |      3 |
+--------+---------------------+--------+
8 rows in set (0.001 sec)

```
Шаг 5
#### Скрипт автоматического бекапа с отправкой на шару.
Использовать cron расписание.

```
#!/bin/usr/env bash

namefile=medcenter_$(date '+%d_%m_%Y')
homedir=/Homework/DevopsHomeWorks/17BD
arh_dir=/mnt/smb/Obmen/backup/
full_file_name=echo"${homedir}/${namefile}.sql"


# Почистим директорию
sudo rm -f $arh_dir

# backup
sudo mysqldump -u root -p${DB_PASS} medcenter > $full_file_name

# Делаем архив
tar -cvf "${arh_dir}${namefile}.tar" $full_file_name


```

#### Или улучшенный:
- c проверкой дампа, 
- тестированием архива 
- логированием
- с удалением архивов старше 7 дней на smb ресурсе
- c отправкой дампа на smb ресурс
- c отправкой лога на smb ресурс

Сохраним пароли sql заранее
```bash
sudo vim /etc/mysql/backup.cnf

[client]
user=root
password=":tcbylf2022"
```


bkp.sh
```bash
#!/usr/bin/env bash
set -euo pipefail
#set -x
# Настройки
namefile="medcenter_$(date '+%Y-%m-%d')"
homedir="/Homework/DevopsHomeWorks/17BD"
arh_dir="/mnt/smb/Obmen/backup"
full_file_name="${namefile}.sql"
archive_name="$arh_dir/$namefile.tar"


cd "$homedir"
# Создаем директории, если их нет
mkdir -p "$arh_dir"

#log_file="${homedir}/backup.log"
log_file="$arh_dir/backup.log"

echo "Log file in: $log_file"



# Функция для логирования
log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" | tee -a "$log_file"
}

# Очистка старых бэкапов (например, старше 7 дней)
cleanup_old_backups() {
    log "Cleaning up old backups..."
    find "$arh_dir" -type f -mtime +7 -exec rm -f {} \;
}

# Создание дампа базы данных
create_backup() {
    log "Creating backup of database 'medcenter'..."
    if mysqldump --defaults-extra-file=/etc/mysql/backup.cnf medcenter > "$full_file_name"; then
        log "Backup successfully created: $full_file_name"        
    else
        log "Backup failed!"
        exit 1
    fi
}

 # проверка количества строк в sql
check_sql_file(){

  if [ ! -f "$full_file_name" ]; then
    log "Error: File $full_file_name does not exist!"
    return 1
  fi

  local records
  records=$(wc -l < "$full_file_name")  
  echo "$records"
}



# Копирование дампа в архивную директорию
copy_to_archive() {
    
    if tar -cvf "$archive_name" "$full_file_name"; then
          
        # test archive
        if tar -tvf "$archive_name" > /dev/null; then
            # remove not need sql file
            rm "$full_file_name"
            log "Backup successfully archived and checkit: $archive_name"
               # Изменяем владельца архива
            sudo chown alrex:alrex "$archive_name"
        else
            log "ERROR: Archive test failed: $archive_name"
            exit 1
        fi      
    else
      log "Failed to create archive!"
      exit 1
    fi
}



main() {
    cleanup_old_backups
    create_backup
    # проверка содержания архива
    records=$(check_sql_file)
    if [ "$records" -lt 2 ]; then
        echo "Файл архива содржит менее 2х строк!!!!"
        log "ERROR: Backup file contains less than 2 records: $full_file_name"
        exit 1
    else
      copy_to_archive
      # sudo chown alrex:alrex /mnt/smb/Obmen/backup/
    fi      
    
}

# Запуск скрипта
main

```


#### CRON Делаем расписание создания архива.
Логи расписания
```bash
sudo touch /var/log/shedule_backup.log
sudo chmod 644 /var/log/shedule_backup.log
```

1 раз в неделю - вo вторник в 10 часов 53 мин (так совпало время при тесте)

```bash
sudo vim /etc/crontab

53 10 * * 2 root bash /home/alrex/Homework/DevopsHomeWorks/17BD/bkp.sh >> /var/log/shedule_backup.log 2>&1
```

```bash
sudo tail -f /var/log/shedule_backup.log

Log file in: /mnt/smb/Obmen/backup/backup.log
2025-07-29 10:53:01 - Cleaning up old backups...
2025-07-29 10:53:01 - Creating backup of database 'medcenter'...
2025-07-29 10:53:01 - Backup successfully created: medcenter_2025-07-29.sql
medcenter_2025-07-29.sql
2025-07-29 10:53:01 - Backup successfully archived and checkit: /mnt/smb/Obmen/backup/medcenter_2025-07-29.tar
```

```bash
sudo ls -l /mnt/smb/Obmen/backup

total 16
-rwxr-xr-x 1 root root   301 Jul 29 10:53 backup.log
-rwxr-xr-x 1 root root 10240 Jul 29 10:53 medcenter_2025-07-29.tar
```
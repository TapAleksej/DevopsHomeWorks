–†–µ–∞–ª–∏–∑–∞—Ü–∏—è https://gitlab.com/Alrexcom/hw32

### –ó–∞–¥–∞—á–∞
#### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è
1. Pipeliene –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ —ç—Ç–∞–ø–æ–≤

- **`code-quality`** - –∑–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–æ–≤
- **`tests`** - –∑–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
- **`build`** - —Å–±–æ—Ä–∫–∞ –∏ –ø—É—à docker image
- **`deploy`** - –∑–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞ _—É–¥–∞–ª–µ–Ω–Ω–æ–π_ –º–∞—à–∏–Ω–µ
- **`notify`** - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–∞—á–∞–ª–µ pipleine –∏ –æ –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ (–≤ –ª—é–±–æ–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä)

2. –≠—Ç–∞–ø **`code-quality`** –¥–æ–ª–∂–µ–Ω –≤–∫–ª—é—á–∞—Ç—å –≤ —Å–µ–±—è –∑–∞–ø—É—Å–∫ –ª–∏–Ω—Ç–µ—Ä–æ–≤ –∫–∞–∫ –¥–ª—è –∫–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Ç–∞–∫ 
–∏ –¥–ª—è —Ñ–∞–π–ª–æ–≤ docker

```
 –ò—Å–ø–æ–ª—å–∑—É—é –ø—Ä–æ–≤–µ—Ä–∫—É —Ñ–∞–π–ª–∞ –¥–æ–∫–µ—Ä–∞ –∏ —Ñ–∞–π–ª–æ–≤ *.js 
 –í–æ—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è —à–∞–±–ª–æ–Ω–æ–º .nmp –¥–ª—è —Å–æ–∫—Ä–∞—â–µ–Ω–∏—è –∫–æ–¥–∞
```

3. –≠—Ç–∞–ø **`tests`** –¥–æ–ª–∂–µ–Ω —Å–æ—Å—Ç–æ—è—Ç—å –∏–∑ –¥–≤—É—Ö jobs:

- –ø–µ—Ä–≤–∞—è –¥–æ–ª–∂–Ω–∞ –ø—Ä–æ–≥–æ–Ω—è—Ç—å unit —Ç–µ—Å—Ç—ã, –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è _–≤—Å–µ–≥–¥–∞_ –∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–∞—Ö —Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏


```js
test:
  stage: tests       
  extends: .npm
  script:
    - npm test  
  artifacts:
    paths:
      - tests-result.json
  rules:
    - when: always

```
–î–ª—è —Ä–∞–±–æ—Ç—ã –ª–∏–Ω—Ç–µ—Ä–∞ js –ø—Ä–∏—à–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥ —Ñ–∞–π–ª `.eslintrc.js`

```js
module.exports = {
    env: {
      browser: true,
      es2021: true,
      node: true,
    },
    extends: "eslint:recommended",
    parserOptions: {
      ecmaVersion: "latest",
      sourceType: "module",
    }      
  };

```
–í package.json

```js
{
  "name": "diary-app",
  "version": "1.0.0",
  "description": "Simple diary with nodejs",
  "main": "server.js",
  "scripts": {
    "code-quality": "eslint . --ext .js,.jsx",              #  —Å—é–¥–∞
    "start": "node server.js",
    "test": "jest --json --outputFile=tests-result.json"    # —Ç–µ—Å—Ç –ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ç–∏–º
  },
  "author": "anestesia",
  "license": "MIT",
  "dependencies": {
    "eslint": "^8.0.0",                                    # –∏ —Å—é–¥–∞
    "body-parser": "^1.20.2",
    "express": "^4.19.2",
    "jest": "^29.7.0",                               # —Ç–µ—Å—Ç –ø–æ–ª—å–∑—É–µ—Ç—Å—è —ç—Ç–∏–º
    "supertest": "^6.3.3"    
  }
}
```

- –≤—Ç–æ—Ä–∞—è –¥–æ–ª–∂–Ω–∞ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è _–ø–æ—Å–ª–µ_ —É–¥–∞—á–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ
	"–∑–∞—à–∏–ª" –≤ **deploy** - –≤ –Ω—ë–º –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø–∏—Å—å –≤ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ - –≤ –æ–¥–∏–Ω —Ñ–∞–π–ª.
	–ú–æ–∂–Ω–æ –∫–æ–Ω–µ—á–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ, –Ω–æ —Ç–æ–≥–¥–∞ –ø—Ä–∏–π–¥—ë—Ç—Å—è —Å–Ω–æ–≤–∞ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –ø–æ ssh –Ω–∞ —Ö–æ—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞,
	–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –∫–æ–¥–∞ - —ç—Ç–æ –≤—Å—ë –≤—Ä–µ–º—è. –õ—É—á—à–µ –≤ –æ–¥–Ω–æ–º.
		
	
–ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—â–µ–Ω–Ω–æ–≥–æ –¥–æ–∫–µ—Ä–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∑–∞–Ω–æ—Å–∏—Ç—Å—è –≤ —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª

4. –≠—Ç–∞–ø **build** –¥–æ–ª–∂–µ–Ω —Å–æ–±–∏—Ä–∞—Ç—å –∏ –ø—É—à–∏—Ç—å docker image –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (registry –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π, —Ö–æ—Ç—å container registry –æ—Ç —Å–∞–º–æ–≥–æ gitlab, —Ö–æ—Ç—å docker hub, —Ö–æ—Ç—å —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π)

```js
build:kaniko:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]   
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$REGISTRY\":{\"username\":\"$REGISTRY_USER\",\"password\":\"$TOKEN32\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "$CI_PROJECT_DIR"
      --dockerfile "$CI_PROJECT_DIR/Dockerfile"
      --destination ${FULL_IMAGE_NAME}
  rules:
    - when: always 
```


5. –≠—Ç–∞–ø **deploy** –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ _—É–¥–∞–ª–µ–Ω–Ω–æ–π –º–∞—à–∏–Ω–µ_ (—Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø—Ä–æ–¥—É–º–∞–π—Ç–µ —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ);
–ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ ssh –∫—É —Ö–æ—Å—Ç—É –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–∫–∞—á–∞–≤ –∏–∑ docker hub.
–°—é–¥–∞ –ø–æ–º–µ—Å—Ç–∏–ª —Ç–µ—Å—Ç –æ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ - –ø—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ

```js
deploy:with-test:
  stage: deploy
  services:
    - name: docker:dind 
      alias: docker
  image: docker:27.5  
  before_script:
    - apk update && apk add openssh-client rsync bash
    - eval "$(ssh-agent -s)"
    - mkdir ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KEY32" | ssh-add -
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config 
  script:
    - |        
        ssh ${SSH_USER}@${HOST} "docker pull ${FULL_IMAGE_NAME} && \
        docker rm -f $APP_NAME || true && \
        docker run -d --name $APP_NAME -p 3000:3000 ${FULL_IMAGE_NAME}
        echo "$(docker inspect -f '{{.State.Status}}' $APP_NAME)"" >> tests-result.json
  artifacts:
      paths:
        - tests-result.json 
  rules:
    - when: always
```
6. –≠—Ç–∞–ø **`notify`** –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –¥–≤–∞–∂–¥—ã:

- –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–∞–π–ø–ª–∞–π–Ω–∞
```js
notify:start:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
        -d chat_id=${TG_CHAT_ID} \
        -d text="üöÄ Pipeline started!
        Project: ${CI_PROJECT_NAME}
        Branch: ${CI_COMMIT_REF_NAME}
        Commit: ${CI_COMMIT_SHORT_SHA}
        Author: ${GITLAB_USER_NAME}
        URL: ${CI_PIPELINE_URL}"
  rules:
    - when: always
```

- –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é –ø–∞–π–ø–ª–∞–π–Ω–∞ (–≤–∫–ª—é—á–∞—è —Å—Ç–∞—Ç—É—Å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è)
- _–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ_ –≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –æ–± –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–∞–π–ª —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ —Ç–µ—Å—Ç–æ–≤

```js
notify:end:
  stage: notify-end
  image: alpine:latest
  dependencies:
    - deploy:with-test
  before_script:
    - apk add --no-cache curl
  script:
    - |
      STATUS="‚úÖ SUCCESS"
      if [[ "$CI_PIPELINE_STATUS" == "failed" ]]; then
        STATUS="‚ùå FAILED"
      elif [[ "$CI_PIPELINE_STATUS" == "canceled" ]]; then
        STATUS="üö´ CANCELED"
      fi

      # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
        -d chat_id=${TG_CHAT_ID} \
        -d text="üèÅ Pipeline finished $STATUS
        Project: ${CI_PROJECT_NAME}
        Branch: ${CI_COMMIT_REF_NAME}
        Commit: ${CI_COMMIT_SHORT_SHA}
        Duration: ${CI_PIPELINE_DURATION}s
        URL: ${CI_PIPELINE_URL}"

      # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
      if [ -f tests-result.json ]; then
        curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
          -F chat_id=${TG_CHAT_ID} \
          -F document=@"tests-result.json" \
          -F caption="üìÑ Test results"
      fi
  rules:
    - when: always
  artifacts:
    paths:
```



## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

.gitlab-ci.yml

```js
stages:
  - notify
  - code-quality 
  - tests
  - build
  - scanning
  - deploy  
  - notify-end


variables:
  APP_NAME: hw32
  TG_CHAT_ID: 421829411
  PRJ_DIR: /opt/hw32
  SSH_USER: gitlab-runner
  HOST: 130.193.41.125
  REGISTRY_USER: alrexcom
  REGISTRY_PATH: hw32
  IMAGE_TAG: $REGISTRY_USER/$REGISTRY_PATH:$CI_COMMIT_SHORT_SHA
  FULL_IMAGE_NAME: ${IMAGE_TAG}_hw32
  REGISTRY: https://index.docker.io/v1/


.npm:
  image: node:20
  before_script:  
    - npm install
  cache:
    paths:
      - node_modules/  


notify:start:
  stage: notify
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
        -d chat_id=${TG_CHAT_ID} \
        -d text="üöÄ Pipeline started!
        Project: ${CI_PROJECT_NAME}
        Branch: ${CI_COMMIT_REF_NAME}
        Commit: ${CI_COMMIT_SHORT_SHA}
        Author: ${GITLAB_USER_NAME}
        URL: ${CI_PIPELINE_URL}"
  rules:
    - when: always


linter:dockerfile:
  stage: code-quality 
  image: hadolint/hadolint:v2.14.0-debian
  script:
    - echo "Checking ... Dockerfile..."
    - hadolint Dockerfile || exit 1
  allow_failure: true
  rules:
    # - if: '$CI_COMMIT_MESSAGE =~ /#full/' 
    - when: always 
   

linter:js_files:
  stage: code-quality
  extends: .npm
  script:
    - echo "Checking ... js files..."
    - npm run code-quality 
  allow_failure: true 
  rules:
    - when: always 
    #- if: '$CI_COMMIT_MESSAGE =~ /#full/'   
 

test:
  stage: tests       
  extends: .npm
  script:
    - npm test  
  artifacts:
    paths:
      - tests-result.json
  rules:
    - when: always


build:kaniko:
  stage: build
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]   
  script:
    - mkdir -p /kaniko/.docker
    - echo "{\"auths\":{\"$REGISTRY\":{\"username\":\"$REGISTRY_USER\",\"password\":\"$TOKEN32\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "$CI_PROJECT_DIR"
      --dockerfile "$CI_PROJECT_DIR/Dockerfile"
      --destination ${FULL_IMAGE_NAME}
  rules:
    - when: always 
    #- if: '$CI_COMMIT_MESSAGE =~ /#full/'
 

deploy:with-test:
  stage: deploy
  services:
    - name: docker:dind 
      alias: docker
  image: docker:27.5  
  before_script:
    - apk update && apk add openssh-client rsync bash
    - eval "$(ssh-agent -s)"
    - mkdir ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_KEY32" | ssh-add -
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config 
  script:
    - |        
        ssh ${SSH_USER}@${HOST} "docker pull ${FULL_IMAGE_NAME} && \
        docker rm -f $APP_NAME || true && \
        docker run -d --name $APP_NAME -p 3000:3000 ${FULL_IMAGE_NAME}
        echo "$(docker inspect -f '{{.State.Status}}' $APP_NAME)"" >> tests-result.json
  artifacts:
      paths:
        - tests-result.json 
  rules:
    - when: always



notify:end:
  stage: notify-end
  image: alpine:latest
  dependencies:
    - deploy:with-test
  before_script:
    - apk add --no-cache curl
  script:
    - |
      STATUS="‚úÖ SUCCESS"
      if [[ "$CI_PIPELINE_STATUS" == "failed" ]]; then
        STATUS="‚ùå FAILED"
      elif [[ "$CI_PIPELINE_STATUS" == "canceled" ]]; then
        STATUS="üö´ CANCELED"
      fi

      # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendMessage" \
        -d chat_id=${TG_CHAT_ID} \
        -d text="üèÅ Pipeline finished $STATUS
        Project: ${CI_PROJECT_NAME}
        Branch: ${CI_COMMIT_REF_NAME}
        Commit: ${CI_COMMIT_SHORT_SHA}
        Duration: ${CI_PIPELINE_DURATION}s
        URL: ${CI_PIPELINE_URL}"

      # –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–∞ —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
      if [ -f tests-result.json ]; then
        curl -s -X POST "https://api.telegram.org/bot${TG_BOT_TOKEN}/sendDocument" \
          -F chat_id=${TG_CHAT_ID} \
          -F document=@"tests-result.json" \
          -F caption="üìÑ Test results"
      fi
  rules:
    - when: always
  artifacts:
    paths:
```
–¢–µ–ª–µ–≥—Ä–∞–º
–ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –≤—ã–¥–∞—ë—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ 
```

```